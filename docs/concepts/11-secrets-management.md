# üîê Secrets Management - Variables d'Environnement S√©curis√©es

---
**M√©tadonn√©es**
- **Niveau :** Interm√©diaire/Avanc√©
- **Dur√©e :** 40 minutes
- **Pr√©requis :** GitHub Actions, concepts de s√©curit√©
---

## üéØ Objectifs d'Apprentissage

√Ä la fin de ce chapitre, vous saurez :
- ‚úÖ Distinguer variables client vs serveur
- ‚úÖ S√©curiser les cl√©s API avec GitHub Secrets
- ‚úÖ Impl√©menter l'injection automatique de configuration
- ‚úÖ Appliquer les bonnes pratiques de s√©curit√©
- ‚úÖ G√©rer les environnements multiples (dev/prod)

---

## üîí Th√©orie des Secrets - Client vs Serveur

### **1. Classification des Donn√©es Sensibles**

#### **Variables c√¥t√© CLIENT (Frontend) :**
```javascript
// ‚úÖ S√õRES √† exposer (avec protections)
const PUBLIC_CONFIG = {
    supabaseUrl: 'https://xxx.supabase.co',         // URL publique
    supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIs...',    // Cl√© anonyme
    appVersion: '1.0.0',                           // M√©tadonn√©es
    apiEndpoint: 'https://api.monapp.com',         // Endpoints publics
    cdnUrl: 'https://cdn.jsdelivr.net'            // URLs externes
};
```

**Pourquoi ces donn√©es sont "s√ªres" :**
- üõ°Ô∏è **Protection RLS** : Supabase Row Level Security limite l'acc√®s
- üîç **Visibilit√© contr√¥l√©e** : Cl√© anonyme = permissions limit√©es
- üìñ **Public par design** : URLs destin√©es √† √™tre connues

#### **Variables c√¥t√© SERVEUR (Backend) :**
```javascript
// ‚ùå JAMAIS exposer c√¥t√© client
const PRIVATE_CONFIG = {
    supabaseServiceKey: 'eyJhbGciOiJIUzI1NiIs...',  // Cl√© admin totale
    databaseUrl: 'postgres://user:pass@host/db',     // Acc√®s direct DB
    jwtSecret: 'super-secret-jwt-key',               // Signature tokens
    emailApiKey: 'key-sendgrid-or-mailgun',         // APIs tierces
    encryptionKey: 'aes-256-encryption-key'         // Chiffrement donn√©es
};
```

**Dangers d'exposition :**
- üí• **Acc√®s total** √† la base de donn√©es
- üîì **Bypass** de toutes les s√©curit√©s
- üí∏ **Utilisation frauduleuse** d'APIs payantes

---

## üèóÔ∏è Architecture S√©curis√©e d'Emoji Code Mood

### **2. Flux de Configuration S√©curis√©e**

#### **Injection automatique par GitHub Actions :**
```mermaid
graph TB
    A[üîê GitHub Secrets] --> B[üèóÔ∏è Build Action]
    B --> C[üìù private-config.js]
    C --> D[üåê D√©ploiement Pages]
    E[üë®‚Äçüíª D√©veloppeur] --> F[üìÅ Code Source]
    F --> G[‚ùå Pas de secrets hardcod√©s]
    
    style A fill:#4caf50
    style G fill:#ff6b6b
    style C fill:#ffc107
```

### **3. Impl√©mentation Pratique**

#### **Template de configuration (NON committ√©) :**
```javascript
// private-config.template.js (exemple, jamais en production)
window.PRIVATE_CONFIG = {
    mode: 'development',
    supabaseUrl: 'VOTRE_SUPABASE_URL',
    supabaseAnonKey: 'VOTRE_SUPABASE_ANON_KEY',
    useRealtime: true,
    debugMode: true
};
```

#### **Configuration r√©elle g√©n√©r√©e automatiquement :**
```yaml
# .github/workflows/deploy-secure.yml
- name: üîí Injection des secrets (Configuration Supabase)
  run: |
    echo "üîë Cr√©ation du fichier de configuration s√©curis√©..."
    
    # Cr√©ation s√©curis√©e avec heredoc
    cat > private-config.js << 'EOF'
    // üîí G√©n√©r√© automatiquement - Ne sera jamais dans Git
    window.PRIVATE_CONFIG = {
      mode: 'production',
      supabaseUrl: '${{ secrets.SUPABASE_URL }}',
      supabaseAnonKey: '${{ secrets.SUPABASE_ANON_KEY }}',
      useRealtime: true,
      
      // M√©tadonn√©es du build
      deployedAt: '${{ github.event.head_commit.timestamp }}',
      deployedBy: 'GitHub Actions',
      commitSha: '${{ github.sha }}',
      version: '1.0.0-secure'
    };
    
    console.log('üé≠ Emoji Code Mood - Configuration automatique charg√©e');
    EOF
```

---

## üõ°Ô∏è Bonnes Pratiques de S√©curit√©

### **4. Validation et V√©rification**

#### **Tests de s√©curit√© automatis√©s :**
```yaml
# V√©rifications de s√©curit√© dans le workflow
- name: üìã V√©rification de s√©curit√©
  run: |
    echo "üîç Audit s√©curit√© automatique..."
    
    # 1. V√©rifier absence de secrets hardcod√©s
    if grep -r "supabaseUrl.*https://" . --exclude-dir=.git --exclude-dir=.github; then
      echo "‚ùå ERREUR: URL Supabase hardcod√©e d√©tect√©e!"
      exit 1
    fi
    
    # 2. V√©rifier absence de cl√©s en dur
    if grep -r "eyJhbGciOiJIUzI1NiIs" . --exclude-dir=.git; then
      echo "‚ùå ERREUR: Cl√© JWT hardcod√©e d√©tect√©e!"
      exit 1
    fi
    
    # 3. V√©rifier que la config est bien inject√©e
    if ! grep -q "window.PRIVATE_CONFIG" private-config.js; then
      echo "‚ùå ERREUR: Configuration non inject√©e!"
      exit 1
    fi
    
    # 4. V√©rifier permissions du fichier
    if [ -f private-config.js ]; then
      echo "‚úÖ Configuration g√©n√©r√©e avec succ√®s"
    fi
    
    echo "‚úÖ Audit s√©curit√© r√©ussi"
```

### **5. Environnements Multiples**

#### **Gestion dev/staging/production :**
```yaml
# Configuration par environnement
- name: üîß Configuration environnement-sp√©cifique
  run: |
    # D√©tection automatique de l'environnement
    if [ "${{ github.ref }}" = "refs/heads/main" ]; then
      ENVIRONMENT="production"
      SUPABASE_URL="${{ secrets.PROD_SUPABASE_URL }}"
      SUPABASE_KEY="${{ secrets.PROD_SUPABASE_ANON_KEY }}"
    elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
      ENVIRONMENT="staging"  
      SUPABASE_URL="${{ secrets.STAGING_SUPABASE_URL }}"
      SUPABASE_KEY="${{ secrets.STAGING_SUPABASE_ANON_KEY }}"
    else
      ENVIRONMENT="development"
      SUPABASE_URL="${{ secrets.DEV_SUPABASE_URL }}"
      SUPABASE_KEY="${{ secrets.DEV_SUPABASE_ANON_KEY }}"
    fi
    
    echo "üåç Environnement d√©tect√©: $ENVIRONMENT"
    
    # Injection avec variables d'environnement
    cat > private-config.js << EOF
    window.PRIVATE_CONFIG = {
      mode: '${ENVIRONMENT}',
      supabaseUrl: '${SUPABASE_URL}',
      supabaseAnonKey: '${SUPABASE_KEY}',
      debugMode: ${ENVIRONMENT !== 'production'},
      useRealtime: true
    };
    EOF
```

---

## üîê Configuration GitHub Secrets

### **6. Organisation des Secrets**

#### **Hi√©rarchie recommand√©e :**
```markdown
üìÅ Repository Secrets (Acc√®s: Ce repo seulement)
‚îú‚îÄ‚îÄ SUPABASE_URL                 # URL du projet Supabase
‚îú‚îÄ‚îÄ SUPABASE_ANON_KEY           # Cl√© anonyme (RLS prot√©g√©e)
‚îú‚îÄ‚îÄ STAGING_SUPABASE_URL        # Environnement de test
‚îî‚îÄ‚îÄ STAGING_SUPABASE_ANON_KEY   # Cl√© test

üè¢ Organization Secrets (Acc√®s: Tous les repos)
‚îú‚îÄ‚îÄ DOCKER_REGISTRY_TOKEN       # Partag√© entre projets
‚îú‚îÄ‚îÄ NOTIFICATION_WEBHOOK        # Notifications √©quipe
‚îî‚îÄ‚îÄ COMPANY_API_KEY            # APIs communes

üåç Environment Secrets (Acc√®s: Environnement sp√©cifique)
‚îú‚îÄ‚îÄ production/PROD_SUPABASE_URL
‚îú‚îÄ‚îÄ staging/STAGING_SUPABASE_URL  
‚îî‚îÄ‚îÄ development/DEV_SUPABASE_URL
```

#### **Configuration via GitHub CLI :**
```bash
# Configuration locale pour d√©veloppement
gh secret set SUPABASE_URL --body "https://xxx.supabase.co"
gh secret set SUPABASE_ANON_KEY --body "eyJhbGciOiJIUzI1NiIs..."

# V√©rification
gh secret list
```

### **7. Rotation des Secrets**

#### **Strat√©gie de renouvellement :**
```javascript
// D√©tection de cl√© expir√©e c√¥t√© client
function validateApiKey() {
    try {
        // D√©coder le JWT pour v√©rifier l'expiration
        const payload = JSON.parse(atob(CONFIG.supabaseAnonKey.split('.')[1]));
        const expiry = payload.exp * 1000; // Conversion en milliseconds
        const now = Date.now();
        
        if (expiry - now < 7 * 24 * 60 * 60 * 1000) { // 7 jours
            console.warn('‚ö†Ô∏è Cl√© API expire bient√¥t, renouvellement n√©cessaire');
            // Notification automatique pour l'admin
        }
        
        return expiry > now;
        
    } catch (error) {
        console.error('‚ùå Cl√© API invalide:', error);
        return false;
    }
}

// Utilisation d√©fensive
async function initSupabase() {
    if (!validateApiKey()) {
        throw new Error('Configuration API invalide ou expir√©e');
    }
    
    // Initialisation normale si cl√© valide
    const { createClient } = window.supabase;
    return createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
}
```

---

## üö® Anti-Patterns √† √âviter

### **8. Erreurs de S√©curit√© Communes**

#### **‚ùå Ce qu'il ne faut JAMAIS faire :**
```javascript
// ERREUR 1: Secrets hardcod√©s
const supabase = createClient(
    'https://abcdefg.supabase.co',           // ‚ùå URL en dur
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...' // ‚ùå Cl√© en dur
);

// ERREUR 2: Variables d'environnement c√¥t√© client  
const config = {
    apiKey: process.env.REACT_APP_SECRET_KEY // ‚ùå Expos√© au build
};

// ERREUR 3: Cl√©s dans localStorage/sessionStorage
localStorage.setItem('apiKey', 'secret-key'); // ‚ùå Accessible via DevTools

// ERREUR 4: Cl√©s dans URLs ou logs
console.log('Config:', { apiKey: secretKey }); // ‚ùå Visible dans DevTools
fetch(`/api/data?key=${apiKey}`);            // ‚ùå Visible network tab

// ERREUR 5: Validation c√¥t√© client uniquement
if (apiKey === 'expected-key') {            // ‚ùå Bypassable
    // Code "s√©curis√©"
}
```

#### **‚úÖ Bonnes pratiques :**
```javascript
// ‚úÖ Configuration inject√©e automatiquement
if (!window.PRIVATE_CONFIG) {
    throw new Error('Configuration manquante - v√©rifiez le d√©ploiement');
}

// ‚úÖ Validation d√©fensive
const config = window.PRIVATE_CONFIG;
if (!config.supabaseUrl || !config.supabaseAnonKey) {
    throw new Error('Configuration Supabase incompl√®te');
}

// ‚úÖ Utilisation s√©curis√©e
const supabase = createClient(config.supabaseUrl, config.supabaseAnonKey);

// ‚úÖ Logs sanitis√©s
console.log('Supabase configur√© pour:', config.supabaseUrl.replace(/https:\/\/([^.]+).*/, 'https://$1.***'));
```

---

## üî¨ Tests de S√©curit√©

### **9. Audit Manuel et Automatique**

#### **Script d'audit s√©curit√© :**
```javascript
// audit-security.js - √Ä ex√©cuter dans DevTools
function auditSecrets() {
    console.log('üîç === AUDIT S√âCURIT√â EMOJI CODE MOOD ===');
    
    // 1. V√©rifier exposition de secrets
    const exposedSecrets = [];
    
    // Recherche dans window
    Object.keys(window).forEach(key => {
        if (key.toLowerCase().includes('secret') || 
            key.toLowerCase().includes('key') ||
            key.toLowerCase().includes('token')) {
            exposedSecrets.push({ type: 'window', key, value: typeof window[key] });
        }
    });
    
    // Recherche dans localStorage
    Object.keys(localStorage).forEach(key => {
        if (key.toLowerCase().includes('secret') ||
            key.toLowerCase().includes('key')) {
            exposedSecrets.push({ type: 'localStorage', key, value: '***' });
        }
    });
    
    // 2. V√©rifier configuration
    const config = window.PRIVATE_CONFIG;
    if (config) {
        console.log('‚úÖ Configuration d√©tect√©e');
        console.log('üåç Environnement:', config.mode || 'non d√©fini');
        console.log('üîó URL Supabase:', config.supabaseUrl ? '‚úÖ Configur√©' : '‚ùå Manquant');
        console.log('üîë Cl√© anonyme:', config.supabaseAnonKey ? '‚úÖ Configur√©' : '‚ùå Manquant');
    } else {
        console.warn('‚ö†Ô∏è Aucune configuration d√©tect√©e');
    }
    
    // 3. Rapport final
    if (exposedSecrets.length > 0) {
        console.warn('üö® Secrets potentiellement expos√©s:', exposedSecrets);
    } else {
        console.log('‚úÖ Aucun secret expos√© d√©tect√©');
    }
    
    // 4. Test de fonctionnalit√© s√©curis√©e
    if (window.supabase && config) {
        console.log('üß™ Test de connexion Supabase...');
        const client = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
        // Test basique de connectivit√©
    }
}

// Ex√©cution
auditSecrets();
```

---

## ‚úÖ R√©capitulatif

**Secrets Management ma√Ætris√© :**
- ‚úÖ **Distinction claire** client vs serveur pour les variables
- ‚úÖ **GitHub Secrets** pour injection s√©curis√©e automatique
- ‚úÖ **Validation automatis√©e** anti-hardcoding dans CI/CD
- ‚úÖ **Environnements multiples** dev/staging/prod
- ‚úÖ **Audit s√©curit√©** manuel et automatis√©

**S√©curit√© en profondeur :**
- üîí **Z√©ro secret** dans le code source
- üîÑ **Injection dynamique** √† l'ex√©cution seulement
- üõ°Ô∏è **Validation d√©fensive** c√¥t√© client
- üìã **Tests automatis√©s** anti-r√©gression
- üîç **Audit r√©gulier** des expositions potentielles

---

**Prochaine √©tape :** [12. HTTPS & CSP](12-https-csp.md) - S√©curit√© transport et contenu

---

*üí° **Astuce P√©dagogique :** Demandez aux √©tudiants de faire un audit s√©curit√© sur d'autres sites avec les DevTools pour identifier les mauvaises pratiques courantes.*
